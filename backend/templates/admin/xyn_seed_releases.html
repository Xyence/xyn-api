{% extends "admin/base_site.html" %}
{% load i18n %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block nav-sidebar %}
  {% include "admin/nav_sidebar.html" %}
{% endblock %}

{% block content %}
  <div id="content-main">
    <p>Plan and apply long-running releases via Xyn Seed. Always plan before apply.</p>

    <form method="post" style="max-width: 920px;">
      {% csrf_token %}
      <input type="hidden" name="action" value="plan" />
      <fieldset class="module aligned">
        <div class="form-row">
          {{ plan_form.release_spec.label_tag }}
          {{ plan_form.release_spec }}
          <p class="help">{{ plan_form.release_spec.help_text }}</p>
        </div>
      </fieldset>
      <div class="submit-row">
        <input type="submit" value="Generate plan" class="default" />
      </div>
    </form>

    {% if plan %}
      <fieldset class="module aligned" style="max-width: 920px; margin-top: 24px;">
        <h2>Plan summary</h2>
        <p><strong>Release:</strong> {{ plan.releaseId }}</p>
        <p><strong>Revision:</strong> {{ plan.revisionFrom }} → {{ plan.revisionTo }}</p>
        <p><strong>Summary:</strong> {{ plan.summary }}</p>
        <h3>Actions</h3>
        <ul>
          {% for action in plan.actions %}
            <li>{{ action.op }} {{ action.targetType }} {{ action.targetName }}</li>
          {% empty %}
            <li>No changes detected.</li>
          {% endfor %}
        </ul>

        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="apply" />
          {{ apply_form.release_id }}
          {{ apply_form.plan_id }}
          <div class="submit-row">
            <input type="submit" value="Apply plan" class="default" />
          </div>
        </form>
      </fieldset>
    {% endif %}

    <form method="post" style="max-width: 480px; margin-top: 24px;">
      {% csrf_token %}
      <input type="hidden" name="action" value="status" />
      <fieldset class="module aligned">
        <div class="form-row">
          {{ status_form.release_id.label_tag }}
          {{ status_form.release_id }}
          <p class="help">{{ status_form.release_id.help_text }}</p>
        </div>
      </fieldset>
      <div class="submit-row">
        <input type="submit" value="Check status" />
      </div>
    </form>

    {% if operation %}
      <fieldset class="module aligned" style="max-width: 920px; margin-top: 24px;">
        <h2>Latest operation</h2>
        <p><strong>ID:</strong> {{ operation.operationId }}</p>
        <p><strong>Status:</strong> {{ operation.status }}</p>
        <p><strong>Message:</strong> {{ operation.message }}</p>
      </fieldset>
    {% endif %}

    {% if status %}
      <fieldset class="module aligned" style="max-width: 920px; margin-top: 24px;">
        <h2>Release status</h2>
        <p><strong>Release:</strong> {{ status.releaseId }}</p>
        <p><strong>Desired revision:</strong> {{ status.desiredRevision }}</p>
        <p><strong>Observed:</strong> {{ status.observed.timestamp }} ({{ status.observed.backend }})</p>
        {% if status.observed.message %}
          <p><strong>Message:</strong> {{ status.observed.message }}</p>
        {% endif %}
        <h3>Services</h3>
        <ul>
          {% for service in status.services %}
            <li>{{ service.name }} — {{ service.state }} ({{ service.health }})</li>
          {% empty %}
            <li>No services reported.</li>
          {% endfor %}
        </ul>
      </fieldset>
    {% endif %}
  </div>
{% endblock %}
