{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://xyence.io/schemas/codegen_result.v1.schema.json",
  "title": "CodegenResult v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "task_id",
    "work_item_id",
    "blueprint_id",
    "summary",
    "repo_results",
    "artifacts",
    "success",
    "started_at",
    "finished_at",
    "errors"
  ],
  "properties": {
    "schema_version": {"type": "string", "const": "codegen_result.v1"},
    "task_id": {"type": "string"},
    "work_item_id": {"type": "string"},
    "blueprint_id": {"type": "string"},
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["outcome", "changes", "risks", "next_steps"],
      "properties": {
        "outcome": {"type": "string"},
        "changes": {"type": "string"},
        "risks": {"type": "string"},
        "next_steps": {"type": "string"}
      }
    },
    "repo_results": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["repo", "files_changed", "commands_executed"],
        "properties": {
          "repo": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "url", "ref", "path_root"],
            "properties": {
              "name": {"type": "string"},
              "url": {"type": "string"},
              "ref": {"type": "string"},
              "path_root": {"type": "string"}
            }
          },
          "files_changed": {"type": "array", "items": {"type": "string"}},
          "patches": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["diff_unified"],
              "properties": {
                "path_hint": {"type": "string"},
                "diff_unified": {"type": "string"}
              }
            }
          },
          "write_files": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["path"],
              "properties": {
                "path": {"type": "string"},
                "content": {"type": "string"},
                "content_base64": {"type": "string"},
                "mode": {"type": "string"},
                "executable": {"type": "boolean"}
              }
            }
          },
          "commands_executed": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["command", "cwd", "exit_code"],
              "properties": {
                "command": {"type": "string"},
                "cwd": {"type": "string"},
                "exit_code": {"type": "integer"},
                "stdout_artifact": {"type": "string"},
                "stderr_artifact": {"type": "string"}
              }
            }
          },
          "commit": {
            "anyOf": [
              {
                "type": "object",
                "additionalProperties": false,
                "required": ["sha", "message", "branch", "pushed"],
                "properties": {
                  "sha": {"type": "string"},
                  "message": {"type": "string"},
                  "branch": {"type": "string"},
                  "pushed": {"type": "boolean"},
                  "pr_url": {"type": "string"}
                }
              },
              {"type": "null"}
            ]
          }
        }
      }
    },
    "artifacts": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["key", "content_type", "description"],
        "properties": {
          "key": {"type": "string"},
          "content_type": {"type": "string"},
          "description": {"type": "string"}
        }
      }
    },
    "success": {"type": "boolean"},
    "started_at": {"type": "string", "format": "date-time"},
    "finished_at": {"type": "string", "format": "date-time"},
    "errors": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["code", "message"],
        "properties": {
          "code": {"type": "string"},
          "message": {"type": "string"},
          "detail": {}
        }
      }
    }
  },
  "allOf": [
    {
      "if": {"properties": {"repo_results": {"items": {"required": ["patches"]}}}},
      "then": {}
    }
  ]
}
